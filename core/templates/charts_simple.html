{% extends "bootstrap/base.html" %}

{% block title %}
Charts test
{% endblock %}

{% block content %}
    <div class="container">
        <h1>ApexCharts Test</h1>
        <div id="chart"></div>
    </div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
    $(document).ready(function() {
        var options = {
            chart: {
                type: 'line'
            },
            series: [{
                name: 'Power Usage',
                data: []
            }],
            xaxis: {
                categories: []
            }
        }

        var chart = new ApexCharts(document.querySelector("#chart"), options);
        chart.render();

        // initial data
        var usages = [];
        var times = [];

        setInterval(function() {
            $.ajax({
                url: "{{ url_for('core.get_new_usage') }}",
                type: "GET",
                success: function(newUsage) {
                    // get current time
                    var date = new Date();
                    var time = date.getHours() + ":" + date.getMinutes() + ":" + date.getSeconds();

                    // Add the new values to the arrays
                    usages.push(newUsage);
                    times.push(time);

                    // Only keep the latest 50 values
                    if (usages.length > 50) {
                        usages = usages.slice(usages.length - 50);
                        times = times.slice(times.length - 50);
                    }

                    // Update the chart
                    chart.updateSeries([{
                        name: 'Power Usage',
                        data: usages
                    }]);

                    chart.updateOptions({
                        xaxis: {
                            categories: times
                        }
                    });
                }
            });
        }, 1000);
    });
</script>
{% endblock %}